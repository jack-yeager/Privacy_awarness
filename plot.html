<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Noise Plot with PyScript</title>
    
    <!-- Include PyScript -->
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>

    <!-- Include a PyScript configuration to specify packages -->
    <py-config>
        packages = ["matplotlib", "numpy"]
    </py-config>

    <!-- Include Matplotlib CSS for rendering plots -->
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .pyscript-container {
            width: 80%;
            margin: 0 auto;
        }
        .controls {
            margin: 20px 0;
        }
    </style>
</head>
<body>
    
    <h1>Interactive Noise Plot</h1>
    <p>Select a noise type and adjust the epsilon value to see its effect:</p>
    
    <!-- HTML Controls for Interactivity -->
    <div class="controls">
        <label for="noise-type">Noise Type:</label>
        <select id="noise-type">
            <option value="Laplace">Laplace</option>
            <option value="Gaussian">Gaussian</option>
        </select>

        <label for="epsilon">Epsilon:</label>
        <input type="range" id="epsilon" min="0.01" max="20" value="1" step="0.01" />
        <span id="epsilon-value">1</span>
    </div>

    <!-- Div to Display the Plot -->
    <div id="plot">
        <img id="plot-image" src="" alt="Plot will appear here">
    </div>

    <!-- PyScript to Execute Python Code -->
    <py-script>
        import matplotlib.pyplot as plt
        import numpy as np

        # Simulated data for demonstration
        X_test = np.linspace(0, 10, 100)
        y_test = 3 * X_test + 5 + np.random.normal(0, 3, size=X_test.shape)
        y_pred_olsr = 3 * X_test + 5
        X_test_b = np.c_[np.ones((100, 1)), X_test]  # Add bias term
        theta_ols = np.array([5, 3])  # Example OLS parameters

        # Laplace mechanism function
        def laplace_mechanism(theta, sensitivity, epsilon):
            noise = np.random.laplace(0, sensitivity / epsilon, size=theta.shape)
            return theta + noise

        # Gaussian noise function
        delta = 1e-5
        sensitivity = 1
        def add_gaussian_noise(theta, epsilon, delta, sensitivity):
            sigma = sensitivity * np.sqrt(2 * np.log(1.25 / delta)) / epsilon
            noise = np.random.normal(0, sigma, size=theta.shape)
            return theta + noise

        # Function to update the plot based on noise type and epsilon
        def update_plot(noise_type, epsilon):
            if noise_type == 'Laplace':
                y_vary_noise = X_test_b.dot(laplace_mechanism(theta_ols, 1, epsilon))
                noise_label = 'with Laplace noise'
            elif noise_type == 'Gaussian':
                y_vary_noise = X_test_b.dot(add_gaussian_noise(theta_ols, epsilon, delta, sensitivity))
                noise_label = 'with Gaussian noise'

            # Create the plot
            plt.figure(figsize=(8, 6))
            plt.plot(X_test, y_vary_noise, label=noise_label)
            plt.scatter(X_test, y_test, color='red', label='Test Data')
            plt.plot(X_test, y_pred_olsr, label='without noise', color='yellow')
            plt.title(f'Effect of Epsilon={epsilon} with {noise_type} noise')
            plt.legend()

            # Save the plot as an image
            plt.savefig("/mnt/data/plot.png")
            plt.close()

    </py-script>

    <!-- JavaScript for Interactivity -->
    <script>
        const epsilonInput = document.getElementById('epsilon');
        const epsilonValue = document.getElementById('epsilon-value');
        const noiseTypeSelect = document.getElementById('noise-type');

        // Update epsilon value display
        epsilonInput.addEventListener('input', () => {
            epsilonValue.textContent = epsilonInput.value;
            updatePythonPlot();
        });

        // Update plot when noise type changes
        noiseTypeSelect.addEventListener('change', () => {
            updatePythonPlot();
        });

        // Function to update the Python plot
        function updatePythonPlot() {
            const noiseType = noiseTypeSelect.value;
            const epsilon = parseFloat(epsilonInput.value);
            pyscript.runPython(`
                update_plot("${noiseType}", ${epsilon})
            `).then(() => {
                // After Python code runs, update the image source
                document.getElementById("plot-image").src = "/mnt/data/plot.png";
            });
        }
    </script>

</body>
</html>
